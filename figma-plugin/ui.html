<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="shared/ui-components.css">
  <style>
    /* Plugin-specific styles go here */
  </style>
</head>
<body>
  <!-- Header -->
  <div class="row row--between">
    <h1>{{PLUGIN_NAME}}</h1>
    <span class="badge" id="selection-badge">0 selected</span>
  </div>

  <div class="divider"></div>

  <!-- Content -->
  <div class="content stack" id="content">
    <div class="empty" id="empty-state">
      <div class="empty-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M9 9h6M9 13h6M9 17h4"/>
        </svg>
      </div>
      <p>Select layers to get started</p>
    </div>

    <div class="card hidden" id="result">
      <div class="label">Result</div>
      <pre class="mono" id="result-content"></pre>
    </div>

    <div class="card card--error hidden" id="error">
      <div class="label">Error</div>
      <p id="error-message"></p>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions mt-auto">
    <button class="btn btn--secondary btn--block" id="cancel">Cancel</button>
    <button class="btn btn--primary btn--block" id="run">
      <span id="run-text">Run</span>
      <div class="spinner hidden" id="run-spinner"></div>
    </button>
  </div>

  <div class="status" id="status"></div>

  <script>
    // ========================================================================
    // DOM ELEMENTS
    // ========================================================================

    const $ = (id) => document.getElementById(id);

    const elements = {
      content: $('content'),
      emptyState: $('empty-state'),
      result: $('result'),
      resultContent: $('result-content'),
      error: $('error'),
      errorMessage: $('error-message'),
      runBtn: $('run'),
      runText: $('run-text'),
      runSpinner: $('run-spinner'),
      cancelBtn: $('cancel'),
      status: $('status'),
      selectionBadge: $('selection-badge'),
    };

    // ========================================================================
    // STATE
    // ========================================================================

    let isLoading = false;

    // ========================================================================
    // UI HELPERS
    // ========================================================================

    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    function setLoading(loading) {
      isLoading = loading;
      elements.runBtn.disabled = loading;
      elements.runText.textContent = loading ? 'Running...' : 'Run';
      loading ? show(elements.runSpinner) : hide(elements.runSpinner);
    }

    function showResult(data) {
      hide(elements.emptyState);
      hide(elements.error);
      show(elements.result);
      elements.resultContent.textContent = JSON.stringify(data, null, 2);
    }

    function showError(message) {
      hide(elements.emptyState);
      hide(elements.result);
      show(elements.error);
      elements.errorMessage.textContent = message;
    }

    function setStatus(text, type = '') {
      elements.status.textContent = text;
      elements.status.className = 'status' + (type ? ` status--${type}` : '');
    }

    function updateSelectionBadge(count) {
      elements.selectionBadge.textContent = `${count} selected`;
    }

    // ========================================================================
    // MESSAGING
    // ========================================================================

    function sendToPlugin(message) {
      parent.postMessage({ pluginMessage: message }, '*');
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      switch (msg.type) {
        case 'result':
          showResult(msg.data);
          setStatus('Complete', 'success');
          break;

        case 'error':
          showError(msg.message);
          setStatus('Error occurred', 'error');
          break;

        case 'loading':
          setLoading(msg.loading);
          break;

        case 'selection-changed':
          updateSelectionBadge(msg.count);
          break;
      }
    };

    // ========================================================================
    // EVENT LISTENERS
    // ========================================================================

    elements.runBtn.addEventListener('click', () => {
      if (!isLoading) {
        sendToPlugin({ type: 'run' });
      }
    });

    elements.cancelBtn.addEventListener('click', () => {
      sendToPlugin({ type: 'close' });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        elements.runBtn.click();
      }
      if (e.key === 'Escape') {
        elements.cancelBtn.click();
      }
    });
  </script>
</body>
</html>
